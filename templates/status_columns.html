{% for validation_type in validations if validation_type in ('RPKI', 'DANE') %}
    <td class="text-center">
        {% set combined_modal_id = tab_id ~ '-' ~ validation_type|lower ~ '-' ~ domain|replace('.', '-') %}
        <button class="status-button" onclick="openModal('{{ combined_modal_id }}')">
            <div class="service-status-group">
                <div class="service-security-details">
                    {% if 'Nameserver of Domain' in validations[validation_type].state[domain] %}
                        <div class="status-detail">
                            {% set state = validations[validation_type].state[domain]['Nameserver of Domain'] %}
                            {% if validation_type == 'DANE' and state.lower() == 'not-valid' %}
                                <i class="fas fa-times-circle status-not-found"></i>
                            {% else %}
                                <i class="fas fa-{% if state.lower() == 'valid' %}check-circle status-valid{% elif state.lower() == 'partially-valid' %}exclamation-triangle status-partially-valid{% elif state.lower() == 'not-found' %}question-circle status-not-found{% else %}times-circle status-not-valid{% endif %}"></i>
                            {% endif %}
                            <span>Nameserver</span>
                        </div>
                    {% endif %}

                    {% if 'Mail Server of Domain' in validations[validation_type].state[domain] %}
                        <div class="status-detail">
                            {% set state = validations[validation_type].state[domain]['Mail Server of Domain'] %}
                            <i class="fas fa-{% if state.lower() == 'valid' %}check-circle status-valid{% elif state.lower() == 'partially-valid' %}exclamation-triangle status-partially-valid{% elif state.lower() == 'not-found' %}question-circle status-not-found{% else %}times-circle status-not-valid{% endif %}"></i>
                            <span>Mailserver</span>
                        </div>
                    {% endif %}

                    {% if 'Nameserver of Mail Server' in validations[validation_type].state[domain] %}
                        <div class="status-detail">
                            {% set state = validations[validation_type].state[domain]['Nameserver of Mail Server'] %}
                            {% if validation_type == 'DANE' and state.lower() == 'not-valid' %}
                                <i class="fas fa-question-circle status-not-found"></i>
                            {% else %}
                                <i class="fas fa-{% if state.lower() == 'valid' %}check-circle status-valid{% elif state.lower() == 'partially-valid' %}exclamation-triangle status-partially-valid{% elif state.lower() == 'not-found' %}question-circle status-not-found{% else %}times-circle status-not-valid{% endif %}"></i>
                            {% endif %}
                            <span>Mailserver-NS</span>
                        </div>
                    {% endif %}
                </div>

            </div>
        </button>

        {% set data_mapping = {
                'Nameserver of Domain': 'domain_ns',
                'Mail Server of Domain': 'domain_mx',
                'Nameserver of Mail Server': 'mailserver_ns'
            } %}

        {% if validation_type == 'RPKI' %}
            {{ rpki_modal(combined_modal_id, domain, validation_type, check_type, validations[validation_type].results[domain], data_mapping[check_type], validations[validation_type].state[domain]) }}
        {% elif validation_type == 'DANE' %}
            {{ dane_modal(combined_modal_id, domain, validation_type, check_type, validations[validation_type].results[domain], data_mapping[check_type], validations[validation_type].state[domain]) }}


        {% endif %}
        {% else %}
        {# Keep original code for other validation types #}
        {% set state = validations[validation_type].state[domain][check_type] %}
        {% set modal_id = tab_id ~ '-' ~ validation_type|lower ~ '-' ~ domain|replace('.', '-') ~ '-' ~ check_type|replace(' ', '-')|lower %}
        {% if state %}
            <button class="status-button" onclick="openModal('{{ modal_id }}')">
                {% set status_mapping = {
                        'valid': {'icon': 'check-circle', 'class': 'status-valid', 'display': 'Valid'},
                        'not-valid': {'icon': 'times-circle', 'class': 'status-not-valid', 'display': 'Not Valid'},
                        'partially-valid': {'icon': 'exclamation-triangle', 'class': 'status-partially-valid', 'display': 'Partially Valid'},
                        'not-found': {'icon': 'question-circle', 'class': 'status-not-found', 'display': 'Not Found'}
                    } %}

                {% if validation_type == 'RPKI' %}
                    {% set status = status_mapping.get(state.lower(), {'icon': 'times-circle', 'class': 'status-not-valid', 'display': state|replace('-', ' ')|title}) %}
                {% else %}
                    {% if validation_type == 'DANE' and (check_type == 'Nameserver of Domain' or check_type == 'Nameserver of Mail Server') %}
                        {% if state.lower() == 'not-valid' %}
                            {% set status = {'icon': 'question-circle', 'class': 'status-not-found', 'display': 'Not Valid'} %}
                        {% else %}
                            {% set status = status_mapping.get(state.lower(), {'icon': 'times-circle', 'class': 'status-not-valid', 'display': state|replace('-', ' ')|title}) %}
                        {% endif %}
                    {% else %}
                        {% set status = status_mapping.get(state.lower(), {'icon': 'times-circle', 'class': 'status-not-valid', 'display': state|replace('-', ' ')|title}) %}
                    {% endif %}
                {% endif %}

                <i class="fas fa-{{ status.icon }} status-icon {{ status.class }}"></i>
                {{ status.display }}
            </button>

            {% set results_data = validations[validation_type].results[domain] %}
            {% set data_mapping = {
                    'Nameserver of Domain': 'domain_ns',
                    'Mail Server of Domain': 'domain_mx',
                    'Nameserver of Mail Server': 'mailserver_ns'
                } %}
            {% set current_data_key = data_mapping[check_type] %}

            {% if validation_type == 'RPKI' %}
                {{ rpki_modal(modal_id, domain, validation_type, check_type, results_data, current_data_key) }}
            {% elif validation_type == 'DANE' %}
                {{ dane_modal(modal_id, domain, validation_type, check_type, results_data, current_data_key) }}
            {% endif %}
        {% else %}
            <span class="status-not-found">
                    Not Available
                </span>
        {% endif %}
    </td>
{% endfor %}

{# DNSSEC Column #}
<td class="text-center">
    {% set root_dnssec_modal_id = 'root-dnssec-' ~ domain|replace('.', '-') %}
    {% if 'DNSSEC' in validations and validations.DNSSEC and validations.DNSSEC.results and domain in validations.DNSSEC.results %}
        <button class="status-button" onclick="openModal('{{ root_dnssec_modal_id }}')">
            {% if validations.DNSSEC.results[domain].dnssec_status.is_signed %}
                <i class="fas fa-check-circle status-icon status-valid"></i>
                Signed
            {% else %}
                <i class="fas fa-times-circle status-icon status-not-valid"></i>
                Unsigned
            {% endif %}
        </button>

        {{ dnssec_modal(root_dnssec_modal_id, domain, 'Root Domain',
       {'dnssec_status': validations.DNSSEC.results[domain].dnssec_status,
        'verification_chain': validations.DNSSEC.results[domain].verification_chain}) }}
    {% else %}
        <span class="status-not-found">Not Available</span>
    {% endif %}
</td>

{# Email Security Column #}
<td class="text-center">
    {% set email_security_modal_id = 'email-security-' ~ domain|replace('.', '-') %}
    {% if 'EMAIL_SECURITY' in validations and validations.EMAIL_SECURITY and domain in validations.EMAIL_SECURITY.state %}
        <button class="status-button" onclick="openModal('{{ email_security_modal_id }}')">
            {% set email_security_state = validations.EMAIL_SECURITY.state[domain] %}
            {% if email_security_state %}
                {% set all_valid = email_security_state.SPF == 'valid' and email_security_state.DKIM == 'valid' and email_security_state.DMARC == 'valid' %}
                <div class="service-status-group">
                    <div class="service-security-details">
                        <div class="status-detail">
                            {% set spf_results = validations.EMAIL_SECURITY.results[domain].spf %}
                            {% if spf_results.has_spf and spf_results.policy_sufficiently_strict %}
                                <i class="fas fa-check-circle status-valid"></i>
                            {% elif spf_results.has_spf and not spf_results.policy_sufficiently_strict %}
                                <i class="fas fa-exclamation-triangle status-partially-valid"></i>
                            {% else %}
                                <i class="fas fa-times-circle status-not-valid"></i>
                            {% endif %}
                            <span>SPF</span>
                        </div>
                        <div class="status-detail">
                            <i class="fas fa-{{ 'check-circle status-valid' if email_security_state.DKIM == 'valid' else 'times-circle status-not-valid' }}"></i>
                            <span>DKIM</span>
                        </div>
                        <div class="status-detail">
                            {% set dmarc_results = validations.EMAIL_SECURITY.results[domain].dmarc %}
                            {% if dmarc_results.record_exists and dmarc_results.valid %}
                                <i class="fas fa-check-circle status-valid"></i>
                            {% elif dmarc_results.record_exists and not dmarc_results.valid %}
                                <i class="fas fa-exclamation-triangle status-partially-valid"></i>
                            {% else %}
                                <i class="fas fa-times-circle status-not-valid"></i>
                            {% endif %}
                            <span>DMARC</span>
                        </div>
                    </div>
                </div>
                </button>

                {{ email_security_modal(email_security_modal_id, domain, validations.EMAIL_SECURITY.results[domain]) }}
            {% else %}
                <i class="fas fa-times-circle status-icon status-not-valid"></i>
                Not Configured
            {% endif %}
    {% else %}
        <span class="status-not-found">Not Available</span>
    {% endif %}
</td>


{% if 'WEB_SECURITY' in validations %}
<td class="text-center">
    {% set web_security_modal_id = tab_id ~ '-web-security-' ~ domain|replace('.', '-') %}
    <button class="status-button" onclick="openModal('{{ web_security_modal_id }}')">
        {% set security_status_class %}
        {% if validations.WEB_SECURITY.state[domain].rating in ['excellent', 'good'] %}
            status-valid
        {% elif validations.WEB_SECURITY.state[domain].rating in ['fair'] %}
            status-partially-valid
        {% else %}
            status-not-valid
        {% endif %}
        {% endset %}
        <i class="fas fa-lock status-icon {{ security_status_class }}"></i>
        Details
    </button>
    {{ web_security_modal(web_security_modal_id, domain, validations.WEB_SECURITY.results[domain]) }}
</td>
{% endif %}