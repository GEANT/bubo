{# modals/email_security_modal.html #}
{% macro email_security_modal(modal_id, domain, results) %}
<div id="{{ modal_id }}" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('{{ modal_id }}')">&times;</span>
        <div class="modal-header">
            <h3>
                <i class="fas fa-envelope-open-text"></i>
                Email Security Details for domain {{ domain }}
            </h3>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('{{ modal_id }}-spf')">
                    <i class="fas fa-shield-alt"></i> SPF
                </button>
                <button class="tab-button" onclick="showTab('{{ modal_id }}-dkim')">
                    <i class="fas fa-signature"></i> DKIM
                </button>
                <button class="tab-button" onclick="showTab('{{ modal_id }}-dmarc')">
                    <i class="fas fa-lock"></i> DMARC
                </button>
            </div>

            {# SPF Tab #}
            <div id="{{ modal_id }}-spf" class="tab-content active">
                <div class="component-header">
                    <h4>SPF Configuration</h4>
                    {% if results.spf.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-search"></i>
                        <strong>Record Status:</strong>
                    </div>
                    <div class="record-details">
                        <div class="detail-row">
                            <i class="fas {{ 'fa-check-circle status-valid' if results.spf.has_spf else 'fa-times-circle status-invalid' }}"></i>
                            <span>{{ '' if results.spf.has_spf else 'No' }} SPF Record has been found for this domain.</span>
                        </div>
                        {% if results.spf.has_spf %}
                        <div class="detail-row">
                            <i class="fas {{ 'fa-check-circle status-valid' if results.spf.policy_sufficiently_strict else 'fa-exclamation-triangle status-warning' }}"></i>
                            <span>SPF Policy is {{ 'sufficiently strict.' if results.spf.policy_sufficiently_strict else 'not sufficiently strict.' }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if results.spf.record %}
                    <div class="record-card">
                        <div class="record-card-header">
                            <i class="fas fa-file-alt"></i>
                            <span>Record</span>
                        </div>
                        <div class="record-card-body">
                            <code class="spf-record">{{ results.spf.record }}</code>
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.redirect_info %}
                    <div class="record-card redirect-card">
                        <div class="record-card-header collapsible" onclick="toggleCollapse(this)">
                            <i class="fas fa-forward"></i>
                            <span>Redirect Information ({{ results.spf.redirect_domain }})</span>
                            <i class="fas fa-chevron-down collapse-icon"></i>
                        </div>
                        <div class="record-card-body">
                            <div class="redirect-record-container">
                                <div class="redirect-section">
                                    <div class="section-label">
                                        <i class="fas fa-file-alt"></i>
                                        <span>Record:</span>
                                    </div>
                                    <div class="section-content">
                                        <code class="spf-record">{{ results.spf.redirect_info.record }}</code>
                                    </div>
                                </div>

                                <div class="redirect-section">
                                    <div class="section-label">
                                        <i class="fas fa-shield-alt"></i>
                                        <span>Policy:</span>
                                    </div>
                                    <div class="section-content">
                                        <span class="policy-badge {{ 'policy-strict' if results.spf.redirect_info.policy in ['-all', '~all'] else 'policy-neutral' }}">
                                            {{ results.spf.redirect_info.policy }}
                                        </span>
                                    </div>
                                </div>

                                {% if results.spf.redirect_info.includes %}
                                    <div class="redirect-section">
                                        <div class="section-label">
                                            <i class="fas fa-link"></i>
                                            <span>Includes:</span>
                                        </div>
                                        <div class="section-content">
                                            <div class="tag-container">
                                                {% for include in results.spf.redirect_info.includes %}
                                                    <span class="tag include-tag">{{ include }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if results.spf.redirect_info.a_records %}
                                    <div class="redirect-section">
                                        <div class="section-label">
                                            <i class="fas fa-server"></i>
                                            <span>A Records:</span>
                                        </div>
                                        <div class="section-content">
                                            <div class="tag-container">
                                                {% for record in results.spf.redirect_info.a_records %}
                                                    <span class="tag a-record-tag">{{ record }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if results.spf.redirect_info.mx_records %}
                                    <div class="redirect-section">
                                        <div class="section-label">
                                            <i class="fas fa-mail-bulk"></i>
                                            <span>MX Records:</span>
                                        </div>
                                        <div class="section-content">
                                            <div class="tag-container">
                                                {% for record in results.spf.redirect_info.mx_records %}
                                                    <span class="tag mx-record-tag">{{ record }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}

                                {% if results.spf.redirect_info.ptr_records %}
                                    <div class="redirect-section">
                                        <div class="section-label">
                                            <i class="fas fa-exchange-alt"></i>
                                            <span>PTR Records:</span>
                                        </div>
                                        <div class="section-content">
                                            <div class="tag-container">
                                                {% for record in results.spf.redirect_info.ptr_records %}
                                                    <span class="tag ptr-record-tag">{{ record }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.policy %}
                    <div class="record-card">
                        <div class="record-card-header">
                            <i class="fas fa-shield-alt"></i>
                            <span>Policy</span>
                        </div>
                        <div class="record-card-body policy-container">
                            <span class="policy-badge {{ 'policy-strict' if results.spf.policy in ['-all', '~all'] else 'policy-neutral' }}">
                                {{ results.spf.policy }}
                            </span>

                            {% if results.spf.policy_sufficiently_strict and results.spf.policy_explanation %}
                                <div class="policy-explanation valid">
                                    <i class="fas fa-check-circle"></i>
                                    <span>{{ results.spf.policy_explanation }}</span>
                                </div>
                            {% elif not results.spf.policy_sufficiently_strict and results.spf.policy_explanation %}
                                <div class="policy-explanation warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>{{ results.spf.policy_explanation }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.dns_lookups %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-search"></i>
                            <strong>DNS Lookups:</strong>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                    <span>{{ results.spf.dns_lookups }} lookup{{ 's' if results.spf.dns_lookups != 1 }}</span>
                            </div>
                            <div class="detail-row">
                                <i class="{{ 'fas fa-check-circle status-valid' if not results.spf.exceeds_lookup_limit else 'fas fa-exclamation-triangle status-warning' }}"></i>
                                <span>{{ 'Within' if not results.spf.exceeds_lookup_limit else 'Exceeds' }} recommended lookup limit (10)</span>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.includes %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-link"></i>
                        <strong>Included Domains:</strong>
                    </div>
                    <ul class="record-list">
                        {% for include in results.spf.includes %}
                            <li>{{ include }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if results.spf.record and 'ip4:' in results.spf.record %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-network-wired"></i>
                        <strong>IPv4 Addresses:</strong>
                    </div>
                    <ul class="record-list">
                        {% for part in results.spf.record.split(' ') %}
                            {% if part.startswith('ip4:') %}
                                <li><code class="ip-address">{{ part[4:] }}</code></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if results.spf.record and 'ip6:' in results.spf.record %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-network-wired"></i>
                        <strong>IPv6 Addresses:</strong>
                    </div>
                    <ul class="record-list">
                        {% for part in results.spf.record.split(' ') %}
                            {% if part.startswith('ip6:') %}
                                <li><code class="ip-address">{{ part[4:] }}</code></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            {# DKIM Tab #}
            <div id="{{ modal_id }}-dkim" class="tab-content">
                <div class="component-header">
                    <h4>DKIM Configuration</h4>
                    {% if results.dkim.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                {% if results.dkim.selectors_found %}
                    {% for selector in results.dkim.selectors_found %}
                        <div class="record-item">
                            <div class="record-header">
                                <i class="fas fa-key"></i>
                                <strong>Selector: {{ selector }}</strong>
                            </div>
                            <code class="monospace">{{ results.dkim.records[selector].record }}</code>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="record-item">
                        <div class="detail-row">
                            <i class="fas fa-times-circle status-invalid"></i>
                            <span>No DKIM Selector has been found for this domain.</span>
                        </div>
                    </div>
                {% endif %}
            </div>

            {# DMARC Tab #}
            <div id="{{ modal_id }}-dmarc" class="tab-content">
                <div class="component-header">
                    <h4>DMARC Configuration</h4>
                    {% if results.dmarc.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-search"></i>
                        <strong>Record Status:</strong>
                    </div>
                    <div class="record-details">
                        <div class="detail-row">
                            <i class="fas {{ 'fa-check-circle status-valid' if results.dmarc.record_exists else 'fa-times-circle status-invalid' }}"></i>
                            <span>{{ '' if results.dmarc.record_exists else 'No' }} DMARC Record has been found for this domain.</span>
                        </div>
                        {% if results.dmarc.record_exists %}
                        <div class="detail-row">
                            <i class="fas {{ 'fa-check-circle status-valid' if results.dmarc.valid else 'fa-times-circle status-invalid' }}"></i>
                            <span>DMARC Record policy is {{ 'sufficiently strict.' if results.dmarc.valid else 'not sufficiently strict.' }}</span>
                        </div>
                        {% endif %}
                    </div>
                </div>

                {% if results.dmarc.record %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-file-alt"></i>
                            <strong>Record:</strong>
                        </div>
                        <code class="monospace">{{ results.dmarc.record }}</code>
                    </div>

                    <div class="record-item">
                        <div class="record-details">
                            <div class="detail-row">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Policy:</strong>
                                <span class="status-badge {{ 'status-valid' if results.dmarc.policy in ['quarantine', 'reject'] else 'status-warning' }}">
                                    {{ results.dmarc.policy }}
                                </span>
                            </div>
                            {% if results.dmarc.error %}
                                <div class="detail-row">
                                        <i class="fas fa-exclamation-triangle"></i> {{ results.dmarc.error }}
                                </div>
                            {% endif %}
                            {% if results.dmarc.sub_policy %}
                                <div class="detail-row">
                                    <i class="fas fa-sitemap"></i>
                                    <strong>Subdomain Policy:</strong>
                                    <span class="status-badge {{ 'status-valid' if results.dmarc.sub_policy in ['quarantine', 'reject'] else 'status-warning' }}">
                                        {{ results.dmarc.sub_policy }}
                                    </span>
                                </div>
                            {% endif %}

                        {%  if results.dmarc.percentage %}
                            <div class="detail-row">
                                <i class="fas fa-percent"></i>
                                <strong>Enforcement Percentage:</strong>
                                {{ results.dmarc.percentage }}
                            </div>
                        {% endif %}
                        {% if results.dmarc.rua %}
                            <div class="detail-row">
                                <i class="fas fa-envelope"></i>
                                <strong>Aggregate Reports (rua):</strong>
                                {{ results.dmarc.rua }}
                            </div>
                        {% endif %}
                        {% if results.dmarc.ruf %}
                            <div class="detail-row">
                                <i class="fas fa-file-alt"></i>
                                <strong>Forensic Reports (ruf):</strong>
                                {{ results.dmarc.ruf }}
                            </div>
                        {% endif %}

                        {% if results.dmarc.warnings %}
                            <div class="record-item">
                                <div class="record-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <strong>Warnings:</strong>
                                </div>
                                <div class="record-details">
                                    {% for warning in results.dmarc.warnings %}
                                        <div class="detail-row">
                                            <i class="fas fa-exclamation-triangle status-warning"></i>
                                            <span>{{ warning }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
/* JavaScript for Collapsible Function */
function toggleCollapse(element) {
    element.classList.toggle('collapsed');
    const content = element.nextElementSibling;
    if (element.classList.contains('collapsed')) {
        content.style.maxHeight = '0';
        content.style.padding = '0 16px';
        content.style.overflow = 'hidden';
    } else {
        content.style.maxHeight = content.scrollHeight + 'px';
        content.style.padding = '16px';
        content.style.overflow = 'visible';
    }
}
</script>
{% endmacro %}