{# modals/email_security_modal.html #}
{% macro email_security_modal(modal_id, domain, results) %}
<div id="{{ modal_id }}" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeModal('{{ modal_id }}')">&times;</span>
        <div class="modal-header">
            <h3>
                <i class="fas fa-envelope-open-text"></i>
                Email Security Details for domain {{ domain }}
            </h3>
        </div>

        <div class="tab-container">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('{{ modal_id }}-spf')">
                    <i class="fas fa-shield-alt"></i> SPF
                </button>
                <button class="tab-button" onclick="showTab('{{ modal_id }}-dkim')">
                    <i class="fas fa-signature"></i> DKIM
                </button>
                <button class="tab-button" onclick="showTab('{{ modal_id }}-dmarc')">
                    <i class="fas fa-lock"></i> DMARC
                </button>
            </div>

            {# SPF Tab #}
            <div id="{{ modal_id }}-spf" class="tab-content active">
                <div class="component-header">
                    <h4>SPF Configuration</h4>
                    {% if results.spf.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                {% if results.spf.record %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-file-alt"></i>
                            <strong>Record:</strong>
                        </div>
                            <code class="monospace">{{ results.spf.record }}</code>
                    </div>
                {% else %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>No SPF record found</strong>
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.policy %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-shield-alt"></i>
                            <strong>Policy:</strong>
                            <div class="detail-row">
                                <span class="status-badge {{ 'spf-valid' if results.spf.policy in ['-all', '~all'] else 'status-warning' }}">
                                    {{ results.spf.policy }}
                                </span>
                            </div>
                        </div>
                        <div class="record-details">
                            {% if results.spf.policy_sufficiently_strict and results.spf.policy_explanation %}
                                <div class="detail-row">
                                    <i class="fas fa-check-circle status-valid"></i>
                                    <span>{{ results.spf.policy_explanation }}</span>
                                </div>
                            {% elif not results.spf.policy_sufficiently_strict and results.spf.policy_explanation %}
                                <div class="detail-row">
                                    <i class="fas fa-exclamation-triangle status-warning"></i>
                                    <span>{{ results.spf.policy_explanation }}</span>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.dns_lookups %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-search"></i>
                            <strong>DNS Lookups:</strong>
                        </div>
                        <div class="record-details">
                            <div class="detail-row">
                                    <span>{{ results.spf.dns_lookups }} lookup{{ 's' if results.spf.dns_lookups != 1 }}</span>
                            </div>
                            <div class="detail-row">
                                <i class="{{ 'fas fa-check-circle status-valid' if not results.spf.exceeds_lookup_limit else 'fas fa-exclamation-triangle status-warning' }}"></i>
                                <span>{{ 'Within' if not results.spf.exceeds_lookup_limit else 'Exceeds' }} recommended lookup limit (10)</span>
                            </div>
                        </div>
                    </div>
                {% endif %}

                {% if results.spf.includes %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-link"></i>
                        <strong>Included Domains:</strong>
                    </div>
                    <ul class="record-list">
                        {% for include in results.spf.includes %}
                            <li>{{ include }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if results.spf.record and 'ip4:' in results.spf.record %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-network-wired"></i>
                        <strong>IPv4 Addresses:</strong>
                    </div>
                    <ul class="record-list">
                        {% for part in results.spf.record.split(' ') %}
                            {% if part.startswith('ip4:') %}
                                <li><code class="ip-address">{{ part[4:] }}</code></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}

                {% if results.spf.record and 'ip6:' in results.spf.record %}
                <div class="record-item">
                    <div class="record-header">
                        <i class="fas fa-network-wired"></i>
                        <strong>IPv6 Addresses:</strong>
                    </div>
                    <ul class="record-list">
                        {% for part in results.spf.record.split(' ') %}
                            {% if part.startswith('ip6:') %}
                                <li><code class="ip-address">{{ part[4:] }}</code></li>
                            {% endif %}
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>

            {# DKIM Tab #}
            <div id="{{ modal_id }}-dkim" class="tab-content">
                <div class="component-header">
                    <h4>DKIM Configuration</h4>
                    {% if results.dkim.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                {% if results.dkim.selectors_found %}
                    {% for selector in results.dkim.selectors_found %}
                        <div class="record-item">
                            <div class="record-header">
                                <i class="fas fa-key"></i>
                                <strong>Selector: {{ selector }}</strong>
                            </div>
                            <code class="monospace">{{ results.dkim.records[selector].record }}</code>
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>No DKIM selectors found</strong>
                        </div>
                    </div>
                {% endif %}
            </div>

            {# DMARC Tab #}
            <div id="{{ modal_id }}-dmarc" class="tab-content">
                <div class="component-header">
                    <h4>DMARC Configuration</h4>
                    {% if results.dmarc.valid %}
                        <span class="status-badge status-valid">
                            <i class="fas fa-check-circle"></i> Valid
                        </span>
                    {% else %}
                        <span class="status-badge status-invalid">
                            <i class="fas fa-times-circle"></i> Invalid
                        </span>
                    {% endif %}
                </div>

                {% if results.dmarc.record %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-file-alt"></i>
                            <strong>Record:</strong>
                        </div>
                        <code class="monospace">{{ results.dmarc.record }}</code>
                    </div>

                    <div class="record-item">
                        <div class="record-details">
                            <div class="detail-row">
                                <i class="fas fa-shield-alt"></i>
                                <strong>Policy:</strong>
                                <span class="status-badge {{ 'status-valid' if results.dmarc.policy in ['quarantine', 'reject'] else 'status-warning' }}">
                                    {{ results.dmarc.policy }}
                                </span>
                            </div>
                            {% if results.dmarc.sub_policy %}
                                <div class="detail-row">
                                    <i class="fas fa-sitemap"></i>
                                    <strong>Subdomain Policy:</strong>
                                    <span class="status-badge {{ 'status-valid' if results.dmarc.sub_policy in ['quarantine', 'reject'] else 'status-warning' }}">
                                        {{ results.dmarc.sub_policy }}
                                    </span>
                                </div>
                            {% endif %}
                            <div class="detail-row">
                                <i class="fas fa-percent"></i>
                                <strong>Enforcement Percentage:</strong>
                                {{ results.dmarc.percentage }}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="record-item">
                        <div class="record-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>No DMARC record found</strong>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endmacro %}